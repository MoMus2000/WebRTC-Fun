<!DOCTYPE html>
<head>
    <style>
        video{
            transform: scaleX(-1);
        }
    </style>
     <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

     <!-- Bootstrap JS bundle (includes Popper.js) -->
     <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <div class="container">
    <h1> Video Chat Application </h1>
    <button onclick="startWebcam()">Start Webcam</button>
    <br>
    <br>
    <div class="row">
        <div class="col-sm">
            <video id="webcam" autoplay></video>
        </div>
        <div class="col-sm">
            <h2>SDP Offer</h2>
            <textarea id="freeform" name="freeform" rows="25" cols="50"></textarea>
        </div>
        <div class="col-sm">
            <h2>SDP Answer</h2>
            <textarea id="answerForm" name="answerForm" rows="25" cols="50"></textarea>
            <button onclick="startConnection()">Make Connection</button>
        </div>
        <div class="col-sm">
            <h2>SDP Answer 2</h2>
            <textarea id="answerForm2" name="answerForm2" rows="25" cols="50"></textarea>
        </div>
        <div class="col-sm">
            <video id="client" autoplay></video> 
        </div>
    </div>
    </div>

    <script>
        let peerConnection = new RTCPeerConnection()

        peerConnection.ontrack = function (event) {
                const el = document.getElementById('client')
                console.log(event)
                el.srcObject = event.streams[0]
                el.autoplay = true
                el.controls = true
            }

        async function startWebcam(){
            try{
                const stream = await navigator.mediaDevices.getUserMedia({video : true})
                const videoElement = document.getElementById("webcam")
                const clientElement = document.getElementById("client")
                videoElement.srcObject = stream;

                let tracks = stream.getTracks();
                for(i=0; i<tracks.length; i++){
                    peerConnection.addTrack(tracks[i], stream)
                }

                const offer = await peerConnection.createOffer()

                await peerConnection.setLocalDescription(offer);
                
                const encryptedOffer = btoa(JSON.stringify(peerConnection.localDescription))

                // const encryptedOffer = btoa(String.fromCharCode(...new Uint8Array(await crypto.subtle.encrypt({ name: 'AES-GCM', iv: new Uint8Array(12) }, await crypto.subtle.generateKey({ name: 'AES-GCM', length: 256 }, true, ['encrypt', 'decrypt']), new TextEncoder().encode(JSON.stringify(offer))))));

                const freeform = document.getElementById("freeform")
                freeform.innerHTML = encryptedOffer
            }
            catch (error){
                console.log("Error accessing the webcam", error)
            }
        }

        async function startConnection(){
            let encryptedAnswer = document.getElementById("answerForm").value
            // console.log(JSON.parse(atob(encryptedAnswer)))
            // await peerConnection.setRemoteDescription(JSON.parse(atob(encryptedAnswer)))
            // console.log("Connection successful")
            // peerConnection.ontrack = function (event) {
            //     const el = document.getElementById('client')
            //     console.log(event)
            //     el.srcObject = event.streams[0]
            //     el.autoplay = true
            // //     el.controls = true
            // }
            peerConnection.onicecandidate = async (event) => {
            //Event that fires off when a new answer ICE candidate is created
                if(event.candidate){
                    console.log('Adding answer candidate...:', event.candidate)
                    document.getElementById('answerForm2').value = btoa(JSON.stringify(peerConnection.localDescription))
                }
            };

            await peerConnection.setRemoteDescription(JSON.parse(atob(encryptedAnswer)));

            let answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer); 
        }
    </script>

</body>
</html>